<!DOCTYPE html>
<html>
  <head>
    <title>URL Shortener - Finan Test</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <style>
        .table td {
            vertical-align: middle; /
        }
        .btn-group-sm > .btn {
            padding: 0.25rem 0.5rem;
        }
        img[title="Click ƒë·ªÉ xem l·ªõn"] {
            border: 1px solid #eee;
            border-radius: 4px;
            transition: transform 0.2s;
        }
        img[title="Click ƒë·ªÉ xem l·ªõn"]:hover {
            transform: scale(1.1);
        }
        .badge {
        font-weight: 500;
    }
    .italic {
        font-style: italic;
    }
  </style>
  <body class="container py-5">
    <h2 class="mb-4">URL Shortener Service</h2>

    <div class="card card-body mb-4">
      <div class="mb-3">
        <label>URL G·ªëc:</label>
        <input
          type="text"
          id="longUrl"
          class="form-control"
          placeholder="https://example.com..."
          onclick="this.select()"
          required
        />
      </div>
      <div class="mb-3">
        <label>Custom Alias (T√πy ch·ªçn):</label>
        <input
          type="text"
          id="customAlias"
          class="form-control"
          placeholder="vidu: khuyen-mai"
        />
      </div>
      <!-- Custome expire -->
      <div class="mb-3">
        <label class="form-label fw-bold"
          >Th·ªùi h·∫°n h·∫øt h·∫°n:</label
        >
        <div class="input-group">
          <input
            type="number"
            id="expireValue"
            class="form-control"
            value="1"
            min="1"
            placeholder="S·ªë l∆∞·ª£ng"
          />
          <select
            id="expireUnit"
            class="form-select"
            style="max-width: 150px"
            onchange="toggleExpireInput()"
          >
            <option value="minutes">
              Ph√∫t
            </option>
            <option value="hours">Gi·ªù</option>
            <option value="days" selected>
              Ng√†y
            </option>
            <option value="infinite">
              V√¥ h·∫°n (‚àû)
            </option>
          </select>
        </div>
        <small class="text-muted italic"
          >* M·∫∑c ƒë·ªãnh l√† 1 ng√†y n·∫øu kh√¥ng t√πy
          ch·ªânh.</small
        >
      </div>
      <button
        class="btn btn-primary"
        onclick="shortenUrl()"
      >
        T·∫°o Link
      </button>
    </div>

    <div
      id="result"
      class="alert alert-success d-none"
    >
      Link c·ªßa b·∫°n:
      <a
        id="shortLink"
        href="#"
        target="_blank"
      ></a>
      <div id="qrcode" class="mt-2"></div>
    </div>

    <h4>Danh s√°ch Link</h4>
    <div
      class="d-flex justify-content-end mb-2"
    >
      <select
        id="sortSelect"
        class="form-select w-auto"
        onchange="loadLinks()"
      >
        <option value="created_at_desc">
          M·ªõi nh·∫•t
        </option>
        <option value="oldest">C≈© nh·∫•t</option>
        <option value="abc">T√™n (A-Z)</option>
        <option value="clicks">
          L∆∞·ª£t click
        </option>
      </select>
    </div>
    <table class="table mt-3">
      <thead>
        <tr>
          <th>M√£</th>
          <th>G·ªëc</th>
          <th>Clicks</th>
          <th>M√£ QR</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody id="linkList"></tbody>
    </table>

    <script>
      async function shortenUrl() {
        const longUrlInput =
          document.getElementById("longUrl");
        const urlValue =
          longUrlInput.value.trim(); // Remove whitespace

        // Check if URL is empty
        if (!urlValue) {
          alert(
            "Vui l√≤ng nh·∫≠p URL c·∫ßn r√∫t g·ªçn!"
          );
          longUrlInput.focus(); // Place cursor back to input
          return;
        }

        // Check https or http format
        if (
          !urlValue.startsWith("http://") &&
          !urlValue.startsWith("https://")
        ) {
          alert(
            "URL ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng http:// ho·∫∑c https://"
          );
          return;
        }

        const durationType =
          document.getElementById(
            "expireUnit"
          ).value;
        // | | 1 to avoid error NaN if input is empty
        const durationValue =
          Number.parseInt(
            document.getElementById(
              "expireValue"
            ).value
          ) || 1;

          // //  Debug data
          // console.log("G·ª≠i ƒëi:", { durationType, durationValue });

        // Check pass all validation
        try {
          const res = await fetch("/shorten", {
            method: "POST",
            headers: {
              "Content-Type":
                "application/json",
            },
            body: JSON.stringify({
              original_url: urlValue,
              custom_alias:
                document.getElementById(
                  "customAlias"
                ).value,
              // set duration
              duration_type: durationType,
              duration_value: durationValue,
            }),
          });

          const data = await res.json();
          if (res.ok) {
            // Display result
            loadLinks();
            // Clear input after submit
            longUrlInput.value = "";
            document.getElementById(
              "customAlias"
            ).value = "";
          } else {
            alert(
              data.error || "C√≥ l·ªói x·∫£y ra"
            );
          }
        } catch (err) {
          console.error("L·ªói:", err);
        }
      }

      async function loadLinks() {
        try {
          const sortVal =
            document.getElementById(
              "sortSelect"
            ).value;
          const res = await fetch(
            "/links?sort=" + sortVal
          );
          if (!res.ok)
            throw new Error(
              "Kh√¥ng th·ªÉ k·∫øt n·ªëi server"
            );

          const data = await res.json();
          const list =
            document.getElementById("linkList");

          if (!data || data.length === 0) {
            list.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ link n√†o ƒë∆∞·ª£c t·∫°o</td></tr>`;
            return;
          }

          // Clear table
          list.innerHTML = data
            .map((l) => {
              const shortFullUrl =
                window.location.origin +
                "/" +
                l.short_code;
              const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${shortFullUrl}`;

              let timerHtml = l.expired_at
                ? `<span class="badge bg-warning text-dark ms-2 countdown" data-expire="${l.expired_at}">‚è± ƒêang t√≠nh...</span>`
                : `<span class="badge bg-light text-muted ms-2">‚àû</span>`;

              //  Create icon or text for browser
              let analyticsHtml = "";
              if (l.last_browser || l.last_os) {
                analyticsHtml = `
        <div style="font-size: 0.7rem; line-height: 1.2;" class="text-muted mt-1">
            <span title="Tr√¨nh duy·ªát cu·ªëi c√πng" class="badge border text-dark fw-normal">
                üåê ${l.last_browser || "N/A"}
            </span>
            <span title="H·ªá ƒëi·ªÅu h√†nh cu·ªëi c√πng" class="badge border text-dark fw-normal">
                üíª ${l.last_os || "N/A"}
            </span>
        </div>
    `;
              }

              return `
             <tr>
    <td>
        <div class="d-flex align-items-center gap-2">
            <a href="/${l.short_code}" target="_blank" class="fw-bold text-decoration-none">${l.short_code}</a>
            <button class="btn btn-sm btn-light border" 
                    onclick="copyToClipboard('${shortFullUrl}')" 
                    title="Copy link">
                üìã
            </button>
        </div>
    </td>
    <td class="text-truncate" style="max-width: 200px;" title="${l.original_url}">${l.original_url}</td>
    <td>
        <div>
            <span class="fw-bold fs-5">${l.click_count}</span> clicks
            ${timerHtml}
        </div>
        ${analyticsHtml} </td>
    <td>
    <button class="btn btn-sm btn-outline-info" 
            onclick="viewLargeQR('${qrImageUrl}')">
        üîç Xem QR
    </button>
    <div class="btn-group btn-group-sm mt-1">
        <button class="btn btn-outline-primary" onclick="downloadQR('${qrImageUrl}', '${l.short_code}')">üíæ</button>
    </div>
</td>
    <td>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-warning" onclick="editLink(${l.id}, '${l.original_url}')">‚úèÔ∏è</button>
            <button class="btn btn-danger" onclick="deleteLink(${l.id})">üóëÔ∏è</button>
        </div>
    </td>
</tr>`;
            })
            .join("");

          if (
            typeof startRealtimeCounter ===
            "function"
          )
            startRealtimeCounter();
        } catch (err) {
          console.error("L·ªói loadLinks:", err);
        }
      }

      function startRealtimeCounter() {
        // Delete old interval
        if (window.cntInterval)
          clearInterval(window.cntInterval);

        window.cntInterval = setInterval(() => {
          document
            .querySelectorAll(".countdown")
            .forEach((el) => {
              const expire = new Date(
                el.getAttribute("data-expire")
              ).getTime();
              const now = new Date().getTime();
              const diff = expire - now;

              if (diff <= 0) {
                el.innerHTML = "H·∫øt h·∫°n";
                el.className =
                  "badge bg-danger ms-2";
              } else {
                const h = Math.floor(
                  diff / (1000 * 60 * 60)
                );
                const m = Math.floor(
                  (diff % (1000 * 60 * 60)) /
                    (1000 * 60)
                );
                const s = Math.floor(
                  (diff % (1000 * 60)) / 1000
                );
                el.innerHTML = `‚è± ${h}h ${m}m ${s}s`;
              }
            });
        }, 1000);
      }

      // Handle toggle pick duration
      function toggleExpireInput() {
        const unit =
          document.getElementById(
            "expireUnit"
          ).value;
        const input = document.getElementById(
          "expireValue"
        );
        if (unit === "infinite") {
          input.classList.add("d-none");
          input.value = 0; // 0 is infinite
        } else {
          input.classList.remove("d-none");
          if (input.value == 0) input.value = 1; // Reset to 1 if before was 0
        }
      }

      // CRUD links
      async function deleteLink(id) {
        if (
          !confirm(
            "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a li√™n k·∫øt n√†y?"
          )
        )
          return;
        try {
          const res = await fetch(
            `/links/${id}`,
            { method: "DELETE" }
          );
          if (res.ok) {
          } else {
            alert("Kh√¥ng th·ªÉ x√≥a li√™n k·∫øt");
          }
        } catch (err) {
          console.error(err);
        }
      }

      async function editLink(id, oldUrl) {
        const newUrl = prompt(
          "Nh·∫≠p URL g·ªëc m·ªõi:",
          oldUrl
        );
        if (!newUrl || newUrl === oldUrl)
          return;

        if (!newUrl.startsWith("http")) {
          alert("URL kh√¥ng h·ª£p l·ªá");
          return;
        }

        try {
          const res = await fetch(
            `/links/${id}`,
            {
              method: "PUT",
              headers: {
                "Content-Type":
                  "application/json",
              },
              body: JSON.stringify({
                original_url: newUrl,
              }),
            }
          );
          if (!res.ok)
            alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i");
        } catch (err) {
          console.error(err);
        }
      }

      // Copy link
      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            console.log("Copied: " + text);
            alert(
              "ƒê√£ copy link th√†nh c√¥ng: " + text
            );
          })
          .catch((err) => {
            console.error("L·ªói copy: ", err);
          });
      }

      // Download QR code
      async function downloadQR(url, code) {
        const response = await fetch(url);
        const blob = await response.blob();
        const downloadUrl =
          window.URL.createObjectURL(blob);
        const link =
          document.createElement("a");
        link.href = downloadUrl;
        link.download = `QR_${code}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Copy QR code
      async function copyQR(url) {
        try {
          const data = await fetch(url);
          const blob = await data.blob();
          await navigator.clipboard.write([
            new ClipboardItem({
              [blob.type]: blob,
            }),
          ]);
          alert(
            "ƒê√£ copy ·∫£nh QR v√†o b·ªô nh·ªõ t·∫°m!"
          );
        } catch (err) {
          alert(
            "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ copy ·∫£nh tr·ª±c ti·∫øp. B·∫°n h√£y d√πng chu·ªôt ph·∫£i -> Copy Image."
          );
        }
      }

      // Zoom QR code
      function viewLargeQR(url) {
        window.open(
          url,
          "_blank",
          "width=300,height=300"
        );
      }

      window.onload = function () {
        console.log(
          "Trang web ƒë√£ t·∫£i xong, b·∫Øt ƒë·∫ßu load data..."
        );
        loadLinks();
      };

      // Define connect WebSocket
      const socket = new WebSocket(
        `ws://${window.location.host}/ws`
      );

      socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        if (data.action === "update_links") {
          console.log(
            "D·ªØ li·ªáu ƒë√£ thay ƒë·ªïi! ƒêang c·∫≠p nh·∫≠t danh s√°ch..."
          );
          loadLinks(); // Recall loadlinks for new data
        }
      };

      socket.onclose = function () {
        console.log(
          "M·∫•t k·∫øt n·ªëi WebSocket. ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i..."
        );
        // auto reconnect
        setTimeout(
          () => location.reload(),
          5000
        );
      };
    </script>
  </body>
</html>
