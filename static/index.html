<!DOCTYPE html>
<html>
  <head>
    <title>URL Shortener - Finan Test</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <style>
    .table td {
        vertical-align: middle; /
    }
    .btn-group-sm > .btn {
        padding: 0.25rem 0.5rem;
    }
    img[title="Click ƒë·ªÉ xem l·ªõn"] {
        border: 1px solid #eee;
        border-radius: 4px;
        transition: transform 0.2s;
    }
    img[title="Click ƒë·ªÉ xem l·ªõn"]:hover {
        transform: scale(1.1);
    }
  </style>
  <body class="container py-5">
    <h2 class="mb-4">URL Shortener Service</h2>

    <div class="card card-body mb-4">
      <div class="mb-3">
        <label>URL G·ªëc:</label>
        <input
          type="text"
          id="longUrl"
          class="form-control"
          placeholder="https://example.com..."
          required
        />
      </div>
      <div class="mb-3">
        <label>Custom Alias (T√πy ch·ªçn):</label>
        <input
          type="text"
          id="customAlias"
          class="form-control"
          placeholder="vidu: khuyen-mai"
        />
      </div>
      <button
        class="btn btn-primary"
        onclick="shortenUrl()"
      >
        T·∫°o Link
      </button>
    </div>

    <div
      id="result"
      class="alert alert-success d-none"
    >
      Link c·ªßa b·∫°n:
      <a
        id="shortLink"
        href="#"
        target="_blank"
      ></a>
      <div id="qrcode" class="mt-2"></div>
    </div>

    <h4>Danh s√°ch Link</h4>
    <table class="table mt-3">
      <thead>
        <tr>
          <th>M√£</th>
          <th>G·ªëc</th>
          <th>Clicks</th>
          <th>M√£ QR</th>
        </tr>
      </thead>
      <tbody id="linkList"></tbody>
    </table>

    <script>
      async function shortenUrl() {
        const longUrlInput =
          document.getElementById("longUrl");
        const urlValue =
          longUrlInput.value.trim(); // Remove whitespace

        // Check if URL is empty
        if (!urlValue) {
          alert(
            "Vui l√≤ng nh·∫≠p URL c·∫ßn r√∫t g·ªçn!"
          );
          longUrlInput.focus(); // Place cursor back to input
          return;
        }

        // Check https or http format
        if (
          !urlValue.startsWith("http://") &&
          !urlValue.startsWith("https://")
        ) {
          alert(
            "URL ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng http:// ho·∫∑c https://"
          );
          return;
        }

        // Check pass all validation
        try {
          const res = await fetch("/shorten", {
            method: "POST",
            headers: {
              "Content-Type":
                "application/json",
            },
            body: JSON.stringify({
              original_url: urlValue,
              custom_alias:
                document.getElementById(
                  "customAlias"
                ).value,
              expires_in_days: 1, // Default 1 day
            }),
          });

          const data = await res.json();
          if (res.ok) {
            // Display result
            loadLinks();
          } else {
            alert(
              data.error || "C√≥ l·ªói x·∫£y ra"
            );
          }
        } catch (err) {
          console.error("L·ªói:", err);
        }
      }

      async function loadLinks() {
        try {
          const res = await fetch("/links");
          if (!res.ok)
            throw new Error(
              "Kh√¥ng th·ªÉ k·∫øt n·ªëi server"
            );

          const data = await res.json();
          const list =
            document.getElementById("linkList");

          // check if data is empty
          if (!data || data.length === 0) {
            list.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Ch∆∞a c√≥ link n√†o ƒë∆∞·ª£c t·∫°o</td></tr>`;
            return;
          }

          list.innerHTML = data
            .reverse()
            .map((l) => {
              // Full URL with short code
              const shortFullUrl =
                window.location.origin +
                "/" +
                l.short_code;
              // 3rd API to generate QR
              const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${shortFullUrl}`;

              let timerHtml = l.expired_at
                ? `<span class="badge bg-warning text-dark ms-2 countdown" data-expire="${l.expired_at}">‚è± ƒêang t√≠nh...</span>`
                : `<span class="badge bg-light text-muted ms-2">‚àû</span>`;
              // Display QR
              return `
        <tr>
            <td><a href="/${l.short_code}" target="_blank" class="fw-bold text-decoration-none">${l.short_code}</a></td>
            <td class="text-truncate" style="max-width: 200px;">${l.original_url}</td>
            <td>
                <span class="fw-bold">${l.click_count}</span>
                ${timerHtml}
            </td>
            <td>
                <div class="d-flex align-items-center gap-2">
                    <img src="${qrImageUrl}" alt="QR" style="width: 50px; cursor: pointer;" 
                         onclick="viewLargeQR('${qrImageUrl}')" title="Click ƒë·ªÉ xem l·ªõn">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="downloadQR('${qrImageUrl}', '${l.short_code}')" title="T·∫£i v·ªÅ">
                            üíæ
                        </button>
                        <button class="btn btn-outline-secondary" onclick="copyQR('${qrImageUrl}')" title="Copy ·∫£nh">
                            üìã
                        </button>
                    </div>
                </div>
            </td>
        </tr>`;
            })
            .join("");

          // Activate realtime counter
          if (
            typeof startRealtimeCounter ===
            "function"
          ) {
            startRealtimeCounter();
          }
        } catch (err) {
          console.error("L·ªói loadLinks:", err);
        }
      }

      function startRealtimeCounter() {
        // Delete old interval
        if (window.cntInterval)
          clearInterval(window.cntInterval);

        window.cntInterval = setInterval(() => {
          document
            .querySelectorAll(".countdown")
            .forEach((el) => {
              const expire = new Date(
                el.getAttribute("data-expire")
              ).getTime();
              const now = new Date().getTime();
              const diff = expire - now;

              if (diff <= 0) {
                el.innerHTML = "H·∫øt h·∫°n";
                el.className =
                  "badge bg-danger ms-2";
              } else {
                const h = Math.floor(
                  diff / (1000 * 60 * 60)
                );
                const m = Math.floor(
                  (diff % (1000 * 60 * 60)) /
                    (1000 * 60)
                );
                const s = Math.floor(
                  (diff % (1000 * 60)) / 1000
                );
                el.innerHTML = `‚è± ${h}h ${m}m ${s}s`;
              }
            });
        }, 1000);
      }

      // Download QR code
      async function downloadQR(url, code) {
        const response = await fetch(url);
        const blob = await response.blob();
        const downloadUrl =
          window.URL.createObjectURL(blob);
        const link =
          document.createElement("a");
        link.href = downloadUrl;
        link.download = `QR_${code}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Copy QR code
      async function copyQR(url) {
        try {
          const data = await fetch(url);
          const blob = await data.blob();
          await navigator.clipboard.write([
            new ClipboardItem({
              [blob.type]: blob,
            }),
          ]);
          alert(
            "ƒê√£ copy ·∫£nh QR v√†o b·ªô nh·ªõ t·∫°m!"
          );
        } catch (err) {
          alert(
            "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ copy ·∫£nh tr·ª±c ti·∫øp. B·∫°n h√£y d√πng chu·ªôt ph·∫£i -> Copy Image."
          );
        }
      }

      // Zoom QR code
      function viewLargeQR(url) {
        window.open(
          url,
          "_blank",
          "width=300,height=300"
        );
      }

      window.onload = function () {
        console.log(
          "Trang web ƒë√£ t·∫£i xong, b·∫Øt ƒë·∫ßu load data..."
        );
        loadLinks();
      };

      // Define connect WebSocket
      const socket = new WebSocket(
        `ws://${window.location.host}/ws`
      );

      socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        if (data.action === "update_links") {
          console.log(
            "D·ªØ li·ªáu ƒë√£ thay ƒë·ªïi! ƒêang c·∫≠p nh·∫≠t danh s√°ch..."
          );
          loadLinks(); // Recall loadlinks for new data
        }
      };

      socket.onclose = function () {
        console.log(
          "M·∫•t k·∫øt n·ªëi WebSocket. ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i..."
        );
        // auto reconnect
        setTimeout(
          () => location.reload(),
          5000
        );
      };
    </script>
  </body>
</html>
