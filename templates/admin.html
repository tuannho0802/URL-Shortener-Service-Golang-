<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>
      Admin Dashboard - Qu·∫£n l√Ω User
    </title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem
          rgba(0, 0, 0, 0.075);
      }
      .table-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div
        class="d-flex justify-content-between align-items-center mb-4"
      >
        <h2>
          <i class="fas fa-user-shield me-2"></i
          >Qu·∫£n l√Ω ng∆∞·ªùi d√πng
        </h2>
        <div>
          <a
            href="/"
            class="btn btn-outline-secondary me-2"
          >
            <i class="fas fa-home"></i> Trang
            ch·ªß
          </a>
          <button
            class="btn btn-danger"
            onclick="logout()"
          >
            <i class="fas fa-sign-out-alt"></i>
            ƒêƒÉng xu·∫•t
          </button>
        </div>
      </div>

      <div class="table-container shadow-sm">
        <table
          class="table table-hover align-middle"
        >
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>T√™n ƒëƒÉng nh·∫≠p</th>
              <th>Quy·ªÅn h·∫°n (Role)</th>
              <th>S·ªë l∆∞·ª£ng Link</th>
              <th class="text-end">Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="userTableBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const token =
        localStorage.getItem("jwt_token");

      // decode token to get user id
      function getMyID() {
        if (!token) return null;
        try {
          const base64Url = token.split(".")[1];

          const base64 = base64Url
            .replaceAll("-", "+")
            .replaceAll("_", "/");

          const jsonPayload =
            decodeURIComponent(
              atob(base64)
                .split("")
                .map(
                  (c) =>
                    "%" +
                    (
                      "00" +
                      c
                        .codePointAt(0)
                        .toString(16)
                    ).slice(-2)
                )
                .join("")
            );

          return JSON.parse(jsonPayload)
            .user_id;
        } catch (error) {
          console.error(
            "L·ªói gi·∫£i m√£ token:",
            error
          );
          return null;
        }
      }

      const myID = getMyID();

      // if not admin redirect to home
      if (
        localStorage.getItem("user_role") !==
        "admin"
      ) {
        alert(
          "B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!"
        );
        globalThis.location.href = "/";
      }

      async function fetchUsers() {
        try {
          const response = await fetch(
            "/api/admin/users",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (!response.ok)
            throw new Error(
              "Kh√¥ng th·ªÉ t·∫£i danh s√°ch user"
            );

          const users = await response.json();
          const tbody = document.getElementById(
            "userTableBody"
          );
          tbody.innerHTML = "";

          users.forEach((user) => {
            // check if user is system admin or me
            const isSystemAdmin =
              user.username === "admin";
            const isMe = user.id === myID;
            const isDisabled =
              isSystemAdmin || isMe;

            const row = `
                    <tr>
                        <td>${user.id}</td>
                        <td>
                            <strong>${
                              user.username
                            }</strong>
                            ${
                              isMe
                                ? '<span class="badge bg-primary ms-1" style="font-size: 10px;">B·∫°n</span>'
                                : ""
                            }
                        </td>
                        <td>
                            <select onchange="updateRole(${
                              user.id
                            }, this.value)" 
                                    class="form-select form-select-sm w-auto"
                                    ${
                                      isDisabled
                                        ? "disabled"
                                        : ""
                                    }>
                                <option value="user" ${
                                  user.role ===
                                  "user"
                                    ? "selected"
                                    : ""
                                }>User</option>
                                <option value="admin" ${
                                  user.role ===
                                  "admin"
                                    ? "selected"
                                    : ""
                                }>Admin</option>
                            </select>
                        </td>
                        <td><span class="badge bg-info text-dark">${
                          user.link_count || 0
                        } links</span></td>
                        <td class="text-end">
                            ${
                              isDisabled
                                ? '<button class="btn btn-sm btn-light text-muted" disabled><i class="fas fa-lock"></i></button>'
                                : `<button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">
                                    <i class="fas fa-trash"></i> X√≥a
                                   </button>`
                            }
                        </td>
                    </tr>
                `;
            tbody.innerHTML += row;
          });
        } catch (error) {
          console.error(error);
        }
      }

      async function updateRole(
        userId,
        newRole
      ) {
        if (
          !confirm(
            `X√°c nh·∫≠n ƒë·ªïi quy·ªÅn sang ${newRole}?`
          )
        )
          return fetchUsers();

        const response = await fetch(
          `/api/admin/users/${userId}/role`,
          {
            method: "PUT",
            headers: {
              "Content-Type":
                "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              role: newRole,
            }),
          }
        );

        if (response.ok) {
          alert("C·∫≠p nh·∫≠t quy·ªÅn th√†nh c√¥ng!");
          fetchUsers();
        } else {
          alert("L·ªói khi c·∫≠p nh·∫≠t!");
          fetchUsers();
        }
      }

      async function deleteUser(userId) {
        if (
          !confirm(
            "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y? M·ªçi li√™n k·∫øt c·ªßa h·ªç c≈©ng s·∫Ω b·ªã x√≥a!"
          )
        )
          return;

        const response = await fetch(
          `/api/admin/users/${userId}`,
          {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          }
        );

        if (response.ok) {
          alert("ƒê√£ x√≥a ng∆∞·ªùi d√πng!");
          fetchUsers();
        } else {
          alert("L·ªói khi x√≥a!");
        }
      }

      function logout() {
        localStorage.clear();
        globalThis.location.href = "/";
      }

      //   websocket
      function connectWebSocket() {
        const token =
          localStorage.getItem("jwt_token");
        if (!token) return;

        const protocol =
          globalThis.location.protocol ===
          "https:"
            ? "wss"
            : "ws";
        const socket = new WebSocket(
          `${protocol}://${globalThis.location.host}/ws?token=${token}`
        );

        socket.onopen = () =>
          console.log(
            "‚úÖ ƒê√£ k·∫øt n·ªëi WebSocket Admin"
          );

        socket.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            console.log(
              "üì© Nh·∫≠n tin nh·∫Øn t·ª´ Server:",
              data
            );

            // listen to both
            if (
              data.action === "update_users" ||
              data.action === "update_links"
            ) {
              console.log(
                "üîÑ ƒêang c·∫≠p nh·∫≠t l·∫°i b·∫£ng d·ªØ li·ªáu..."
              );
              fetchUsers();
            }
          } catch (e) {
            console.error(
              "‚ùå L·ªói x·ª≠ l√Ω tin nh·∫Øn WS:",
              e
            );
          }
        };

        socket.onclose = () => {
          console.log(
            "üîå WS b·ªã ng·∫Øt k·∫øt n·ªëi. ƒêang th·ª≠ l·∫°i sau 3s..."
          );
          setTimeout(connectWebSocket, 3000);
        };
      }

      // load data
      window.onload = fetchUsers;
    </script>
  </body>
</html>
