<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>
      Admin Dashboard - Quản lý User
    </title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem
          rgba(0, 0, 0, 0.075);
      }
      .table-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div
        class="d-flex justify-content-between align-items-center mb-4"
      >
        <h2>
          <i class="fas fa-user-shield me-2"></i
          >Quản lý người dùng
        </h2>
        <div>
          <a
            href="/"
            class="btn btn-outline-secondary me-2"
          >
            <i class="fas fa-home"></i> Trang
            chủ
          </a>
          <button
            class="btn btn-danger"
            onclick="logout()"
          >
            <i class="fas fa-sign-out-alt"></i>
            Đăng xuất
          </button>
        </div>
      </div>

      <div class="table-container shadow-sm">
        <table
          class="table table-hover align-middle"
        >
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Tên đăng nhập</th>
              <th>Quyền hạn (Role)</th>
              <th>Số lượng Link</th>
              <th class="text-end">Thao tác</th>
            </tr>
          </thead>
          <tbody id="userTableBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const token =
        localStorage.getItem("jwt_token");

      // decode token to get user id
      function getMyID() {
        if (!token) return null;
        try {
          const base64Url = token.split(".")[1];

          const base64 = base64Url
            .replaceAll("-", "+")
            .replaceAll("_", "/");

          const jsonPayload =
            decodeURIComponent(
              atob(base64)
                .split("")
                .map(
                  (c) =>
                    "%" +
                    (
                      "00" +
                      c
                        .codePointAt(0)
                        .toString(16)
                    ).slice(-2)
                )
                .join("")
            );

          return JSON.parse(jsonPayload)
            .user_id;
        } catch (error) {
          console.error(
            "Lỗi giải mã token:",
            error
          );
          return null;
        }
      }

      const myID = getMyID();

      // if not admin redirect to home
      if (
        localStorage.getItem("user_role") !==
        "admin"
      ) {
        alert(
          "Bạn không có quyền truy cập trang này!"
        );
        globalThis.location.href = "/";
      }

      async function fetchUsers() {
        try {
          const response = await fetch(
            "/api/admin/users",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (!response.ok)
            throw new Error(
              "Không thể tải danh sách user"
            );

          const users = await response.json();
          const tbody = document.getElementById(
            "userTableBody"
          );
          tbody.innerHTML = "";

          users.forEach((user) => {
            // check if user is system admin or me
            const isSystemAdmin =
              user.username === "admin";
            const isMe = user.id === myID;
            const isDisabled =
              isSystemAdmin || isMe;

            const row = `
                    <tr>
                        <td>${user.id}</td>
                        <td>
                            <strong>${
                              user.username
                            }</strong>
                            ${
                              isMe
                                ? '<span class="badge bg-primary ms-1" style="font-size: 10px;">Bạn</span>'
                                : ""
                            }
                        </td>
                        <td>
                            <select onchange="updateRole(${
                              user.id
                            }, this.value)" 
                                    class="form-select form-select-sm w-auto"
                                    ${
                                      isDisabled
                                        ? "disabled"
                                        : ""
                                    }>
                                <option value="user" ${
                                  user.role ===
                                  "user"
                                    ? "selected"
                                    : ""
                                }>User</option>
                                <option value="admin" ${
                                  user.role ===
                                  "admin"
                                    ? "selected"
                                    : ""
                                }>Admin</option>
                            </select>
                        </td>
                        <td><span class="badge bg-info text-dark">${
                          user.link_count || 0
                        } links</span></td>
                        <td class="text-end">
                            ${
                              isDisabled
                                ? '<button class="btn btn-sm btn-light text-muted" disabled><i class="fas fa-lock"></i></button>'
                                : `<button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">
                                    <i class="fas fa-trash"></i> Xóa
                                   </button>`
                            }
                        </td>
                    </tr>
                `;
            tbody.innerHTML += row;
          });
        } catch (error) {
          console.error(error);
        }
      }

      async function updateRole(
        userId,
        newRole
      ) {
        if (
          !confirm(
            `Xác nhận đổi quyền sang ${newRole}?`
          )
        )
          return fetchUsers();

        const response = await fetch(
          `/api/admin/users/${userId}/role`,
          {
            method: "PUT",
            headers: {
              "Content-Type":
                "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              role: newRole,
            }),
          }
        );

        if (response.ok) {
          alert("Cập nhật quyền thành công!");
          fetchUsers();
        } else {
          alert("Lỗi khi cập nhật!");
          fetchUsers();
        }
      }

      async function deleteUser(userId) {
        if (
          !confirm(
            "Bạn có chắc chắn muốn xóa người dùng này? Mọi liên kết của họ cũng sẽ bị xóa!"
          )
        )
          return;

        const response = await fetch(
          `/api/admin/users/${userId}`,
          {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          }
        );

        if (response.ok) {
          alert("Đã xóa người dùng!");
          fetchUsers();
        } else {
          alert("Lỗi khi xóa!");
        }
      }

      function logout() {
        localStorage.clear();
        globalThis.location.href = "/";
      }

      //   websocket
      function connectWebSocket() {
        const token =
          localStorage.getItem("jwt_token");
        if (!token) return;

        const socket = new WebSocket(
          `ws://${window.location.host}/ws?token=${token}`
        );

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          // check if action is update_links
          if (data.action === "update_links") {
            console.log(
              "Dữ liệu hệ thống thay đổi, đang cập nhật danh sách User..."
            );
            fetchUsers();
          }
        };

        socket.onclose = () => {
          setTimeout(connectWebSocket, 3000);
        };
      }

      connectWebSocket();

      // load data
      window.onload = fetchUsers;
    </script>
  </body>
</html>
